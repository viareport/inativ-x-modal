<element name="vr-selectable">
    <style>
        .vr-selectable-highlighted {
            border: 1px solid black;
        }
        .vr-selectable-selected {
            background: #e5e5e5;
            color: white;
        }
    </style>

    <template>
        <content></content>
    </template>
        
    <script>

        var KEY = {
            ENTER: 13,
            LEFT: 37,
            UP: 38,
            RIGHT: 39,
            DOWN: 40
        };

        var keylistener = function(e) {
            switch(e.keyCode) {
                case KEY.ENTER: {
                    break;
                }
                case KEY.DOWN: {
                    this.selectNext();
                    break;
                }
                case KEY.UP: {
                    this.selectPrevious();
                    break;
                }
                default:
                    return;
            }
        };

        var handleMutations = function(mutations) {
            this.removeAttribute('selected');
            this.selectFirst();
        };

        var select = function(element) {
            this.setAttribute('selected', this.getItems().indexOf(element));
            // trigger event "select"
        };

        var clicklistener = function(e) {
            select.call(this, e.target);
        };


        ({
            readyCallback: function() {

                /* bind events */
                this._keyHandler_ = keylistener.bind(this);
                document.addEventListener('keyup', this._keyHandler_, false);

                this._clickHandler_ = clicklistener.bind(this);
                this.addEventListener('click', this._clickHandler_, false);

                this.observer = new MutationObserver(handleMutations.bind(this));
                var config = { attributes: false, childList: true, characterData: false };
                // pass in the target node, as well as the observer options
                this.observer.observe(this, config);
                //this.observer.disconnect();
            },

            insertedCallback: function() {
                this.selectFirst();
            },

            attributeChanged: function(name, oldValue, newValue) {
                if (name === 'selected' || newValue !== null) {
                    if (oldValue !== null) {
                        this.getItem(oldValue).classList.remove('vr-selectable-selected');
                    }
                    this.getItem(newValue).classList.add('vr-selectable-selected');
                }
            },


            getSelectedItem: function() {
                return this.getItems()[this.getAttribute('selected')] || null;
            },

            getItem: function(pos) {
                return this.getItems()[pos] || null;
            },

            getItemCount: function() {
                return this.getItems().length;
            },

            getItems: function() {
                var target = this.getAttribute('target');
                var nodes = target ? this.querySelectorAll(target) : this.children;
                return Array.prototype.slice.call(nodes, 0);
            },

            selectFirst: function() {
                if (this.getItemCount() === 0) return;
                this.setAttribute('selected', this.getAttribute('selected') || 0); // ???
            },

            selectNext: function() {
                var selected = Number(this.getAttribute('selected'));
                if (selected < this.getItemCount() - 1) this.setAttribute('selected', ++selected);
            },

            selectPrevious: function() {
                var selected = Number(this.getAttribute('selected'));
                if (selected > 0) this.setAttribute('selected', --selected);
            }            
        });
    </script>
</element>