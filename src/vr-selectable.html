<element name="vr-selectable">
    <style>
        .vr-selectable-focus {
            border: 1px solid black;
        }
        .vr-selectable-selected {
            background: #e5e5e5;
            color: white;
        }
    </style>

    <template>
        <content></content>
    </template>
        
    <script>
        ({
            readyCallback: function() {
                this.selectFirst();

                /* bind events */
                this.keyHandler = this.keylistener.bind(this);

                document.addEventListener('keyup', this.keyHandler, false);

                this.clickHandler = this.clicklistener.bind(this);
                this.addEventListener('click', this.clickHandler, false);

                this.observer = new MutationObserver(this.handleMutations.bind(this));
                var config = { attributes: false, childList: true, characterData: false };
                // pass in the target node, as well as the observer options
                this.observer.observe(this, config);
                //this.observer.disconnect();
            },

            handleMutations: function(mutations) {
                mutations.forEach(function(mutation) {
                    console.log(mutation);
                    this.removeAttribute('selected');
                    this.selectFirst();
                }, this);
            },

            handleEvent: function(e) {
                console.log(e);
            },

            getItem: function(pos) {
                return this.getItems()[pos] || null;
            },

            getItemCount: function() {
                return this.getItems().length;
            },

            getItems: function() {
                var target = this.getAttribute('target');
                return target ? this.querySelectorAll(target) : this.children;
            },

            ENTER: 13,
            LEFT: 37,
            UP: 38,
            RIGHT: 39,
            DOWN: 40,

            keylistener: function(e) {
                switch(e.keyCode) {
                    case this.ENTER: {

                    }
                    case this.DOWN: {
                        this.selectNext();
                        break;
                    }
                    case this.UP: {
                        this.selectPrevious();
                        break;
                    }
                    default:
                        return;
                }
            },

            clicklistener: function(e) {
                this._select_(e.target);
            },

            selectFirst: function() {
                if (this.getItemCount() === 0) return;
                this.setAttribute('selected', this.getAttribute('selected') || 0);
            },

            selectNext: function() {
                var selected = Number(this.getAttribute('selected'));
                if (selected < this.getItemCount() - 1) this.setAttribute('selected', ++selected);
            },

            selectPrevious: function() {
                var selected = Number(this.getAttribute('selected'));
                if (selected > 0) this.setAttribute('selected', --selected);
            },

            attributeChanged: function(name, oldValue, newValue) {
                if (name !== 'selected' || newValue === null) return;
                if (oldValue !== null) this.getItem(oldValue).classList.remove('vr-selectable-focus');
                this.getItem(newValue).classList.add('vr-selectable-focus');
            },

            _select_: function(element) {
                element.classList.add('vr-selectable-selected');
                // trigger event "select"
            }
            
        });
    </script>
</element>