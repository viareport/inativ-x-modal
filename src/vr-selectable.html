<element name="vr-selectable">
    <style>        
    </style>

    <template>
        <div tabindex="-1">
            <content></content>
        </div>
    </template>
        
    <script>

        var KEY = {
            ENTER: 13,
            LEFT: 37,
            UP: 38,
            RIGHT: 39,
            DOWN: 40
        };

        var keylistener = function(e) {
            switch(e.keyCode) {
                case KEY.ENTER: {
                    this.selectHighlighted();
                    break;
                }
                case KEY.DOWN: {
                    this.highlightNext();
                    break;
                }
                case KEY.UP: {
                    this.highlightPrevious();
                    break;
                }
                default:
                    return;
            }
        };

        var handleMutations = function(mutations) {
            this.removeAttribute('selected');
            highlightFirst.call(this);
        };

        var clicklistener = function(e) {
            this.select(e.target);
        };

        var highlightFirst = function() {
            if (this.getItemCount() === 0) return;
            this.setAttribute('highlighted', this.getAttribute('highlighted') || 0); // ???
        };

        ({
            readyCallback: function() {

                /* bind events */
                this._keyHandler_ = keylistener.bind(this);
                this.addEventListener('keyup', this._keyHandler_, false);

                this._clickHandler_ = clicklistener.bind(this);
                this.addEventListener('click', this._clickHandler_, false);

                this._blur_ = this.doBlur.bind(this);
                this.querySelector("div").addEventListener('blur', this._blur_, false)

                this.addEventListener('mouseover', this.mouseoverListener, false);

                this.observer = new MutationObserver(handleMutations.bind(this));
                var config = { attributes: false, childList: true, characterData: false };
                // pass in the target node, as well as the observer options
                this.observer.observe(this, config);
                //this.observer.disconnect();
            },

            insertedCallback: function() {
                highlightFirst.call(this);
            },

            attributeChanged: function(name, oldValue, newValue) {
                if (name === 'highlighted') {
                    this.toggleItemClass('vr-selectable-highlighted', oldValue, newValue);
                } else if (name === 'selected') {
                    this.toggleItemClass('vr-selectable-selected', oldValue, newValue);
                }
            },

            //TODO privé
            toggleItemClass: function(className, oldIndex, newIndex) {
                if (oldIndex !== null) {
                    this.getItem(oldIndex).classList.remove(className);
                }
                
                if (newIndex !== null) {
                    this.getItem(newIndex).classList.add(className);
                }
            },

            /*
            getSelectedItem: function() {
                return this.getItems()[this.getAttribute('selected')] || null;
            },*/            

            getItem: function(pos) {
                return this.getItems()[pos] || null;
            },

            getItemCount: function() {
                return this.getItems().length;
            },

            getItems: function() {
                var target = this.getAttribute('target');
                var nodes = target ? this.querySelectorAll(target) : this.children;
                return Array.prototype.slice.call(nodes, 0);
            },

            // TODO Privé
            highlightNext: function() {
                var highlighted = Number(this.getAttribute('highlighted'));
                if (highlighted < this.getItemCount() - 1) this.setAttribute('highlighted', ++highlighted);
            },

            // TODO Privé
            highlightPrevious: function() {
                var highlighted = Number(this.getAttribute('highlighted'));
                if (highlighted > 0) this.setAttribute('highlighted', --highlighted);
            },

            // TODO Privé
            selectHighlighted: function() {
                var highlighted = this.getAttribute('highlighted');
                if (highlighted) {
                    this.setAttribute('selected', highlighted);
                }
            },

            // TODO Privé
            mouseoverListener: function(e) {
                if(this.getItems().indexOf(e.target) >= 0) {
                    this.highlight(e.target);
                }
            },

            highlight: function(element) {
                if (element) {                   
                    var elementIndex =  this.getItems().indexOf(element);
                    this.focus();
                    this.setAttribute('highlighted', elementIndex);
                }
            },

            focus: function() {
                this.querySelector("div").focus();
            },

            //TODO Privé
            doBlur: function() {
                this.removeAttribute('highlighted');
            },

            blur: function() {
                var focus = document.createEvent('Event');
                focus.initEvent("blur", false, false);

                this.querySelector("div").dispatchEvent(focus);
            },

            select: function(element) {

                if (element) {                   
                    var elementIndex =  this.getItems().indexOf(element);

                    this.setAttribute('highlighted', elementIndex);
                    this.setAttribute('selected', elementIndex);
                }
            },
        });
    </script>
</element>